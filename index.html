<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Energy Rental dApp</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.1.0/dist/TronWeb.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">
                ğŸ”‹ TRON Energy Rental dApp
            </h1>
            
            <!-- åˆç´„è©³æƒ… -->
            <div id="contract-details" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-lg font-semibold text-blue-800 mb-2">ğŸ“‹ Contract Details</h2>
                <div class="space-y-1 text-sm">
                    <p><strong>Contract:</strong> <span id="contract-address" class="font-mono"></span></p>
                    <p><strong>Function:</strong> <span id="function-name" class="font-mono"></span></p>
                    <p><strong>Parameters:</strong> <span id="parameters" class="font-mono"></span></p>
                    <p><strong>Value:</strong> <span id="call-value"></span> TRX</p>
                    <p><strong>Fee Limit:</strong> <span id="fee-limit"></span> SUN</p>
                </div>
            </div>
            
            <!-- éŒ¢åŒ…ç‹€æ…‹ -->
            <div id="wallet-status" class="mb-6 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">ğŸ’³ Wallet Status</h2>
                <p id="wallet-info" class="text-sm"></p>
            </div>
            
            <!-- æ“ä½œæŒ‰éˆ• -->
            <div id="action-buttons" class="mb-6 text-center">
                <button id="connect-wallet" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                    Connect Wallet
                </button>
                <button id="execute-transaction" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>
                    Execute Transaction
                </button>
            </div>
            
            <!-- åŠ è¼‰å‹•ç•« -->
            <div id="loading" class="hidden text-center mb-6">
                <div class="inline-flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-2">Processing...</span>
                </div>
            </div>
            
            <!-- éŒ¯èª¤ä¿¡æ¯ -->
            <div id="error" class="hidden mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>
            
            <!-- æˆåŠŸä¿¡æ¯ -->
            <div id="success" class="hidden mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <strong>Success:</strong> <span id="success-message"></span>
            </div>
            
            <!-- ä½¿ç”¨èªªæ˜ -->
            <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-2">ğŸ“– Instructions</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>â€¢ Please open this dApp in TronLink's built-in browser</li>
                    <li>â€¢ Make sure you're connected to the correct network</li>
                    <li>â€¢ Ensure you have sufficient energy and bandwidth</li>
                    <li>â€¢ Check your USDT allowance if depositing funds</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let tronWeb;
        let contractInstance;
        let transactionDetails;

        // é¡¯ç¤ºéŒ¯èª¤ä¿¡æ¯
        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            errorMessage.innerHTML = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // é¡¯ç¤ºæˆåŠŸä¿¡æ¯
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            const successMessage = document.getElementById('success-message');
            successMessage.innerHTML = message;
            successDiv.classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // éš±è—æ‰€æœ‰ç‹€æ…‹ä¿¡æ¯
        function hideMessages() {
            document.getElementById('error').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // è§£æ URL åƒæ•¸
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const details = {
                txId: urlParams.get('tx_id'),
                contractAddress: urlParams.get('contract'),
                functionName: urlParams.get('function'),
                params: urlParams.get('params') ? JSON.parse(urlParams.get('params')) : [],
                callValue: parseInt(urlParams.get('value') || '0'),
                feeLimit: parseInt(urlParams.get('feeLimit') || '50000000')
            };
            
            console.log('Parsed transaction details:', details);
            return details;
        }

        // é¡¯ç¤ºäº¤æ˜“è©³æƒ…
        function displayTransactionDetails(details) {
            document.getElementById('contract-address').textContent = details.contractAddress || 'Not specified';
            document.getElementById('function-name').textContent = details.functionName || 'Not specified';
            document.getElementById('parameters').textContent = JSON.stringify(details.params, null, 2);
            document.getElementById('call-value').textContent = (details.callValue / 1000000).toFixed(6);
            document.getElementById('fee-limit').textContent = details.feeLimit.toLocaleString();
        }

        // æª¢æŸ¥éŒ¢åŒ…é€£æ¥
        function checkWalletConnection() {
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;
                
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-green-600">âœ… Connected</span><br/>
                    <strong>Address:</strong> ${address}<br/>
                    <strong>Network:</strong> ${tronWeb.fullNode.host}
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
                document.getElementById('connect-wallet').style.display = 'none';
                document.getElementById('execute-transaction').disabled = false;
                
                return true;
            } else {
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-red-600">âŒ Not Connected</span><br/>
                    Please open this dApp in TronLink's built-in browser
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                document.getElementById('connect-wallet').style.display = 'inline-block';
                document.getElementById('execute-transaction').disabled = true;
                
                return false;
            }
        }

        // åˆå§‹åŒ–åˆç´„
        async function initializeContract(contractAddress) {
            try {
                if (!tronWeb) {
                    throw new Error('TronWeb not available');
                }
                
                contractInstance = await tronWeb.contract().at(contractAddress);
                console.log('Contract initialized:', contractAddress);
                return true;
            } catch (error) {
                console.error('Failed to initialize contract:', error);
                showError(`Failed to initialize contract: ${error.message}`);
                return false;
            }
        }

        // åŸ·è¡Œäº¤æ˜“
        async function executeTransaction(details) {
            let loadingElement = null;
            
            try {
                loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.classList.remove('hidden');
                    loadingElement.innerHTML = '<div class="inline-flex items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-2">Waiting for wallet approval...</span></div>';
                }
                
                console.log('Starting transaction with details:', details);
                
                // æ§‹å»ºäº¤æ˜“åƒæ•¸
                const functionSelector = details.functionName.split('(')[0];
                const params = details.params.map(p => p.value);
                
                console.log('Calling function:', functionSelector, 'with params:', params);
                
                // æ›´æ–°ç‹€æ…‹
                if (loadingElement) {
                    loadingElement.innerHTML = '<div class="inline-flex items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-2">Signing transaction...</span></div>';
                }
                
                // èª¿ç”¨åˆç´„å‡½æ•¸ï¼ˆä¸ç­‰å¾…ç¢ºèªï¼Œåªç­‰å¾…ç°½ç½²ï¼‰
                const tx = await contractInstance[functionSelector](...params)
                    .send({
                        feeLimit: details.feeLimit,
                        callValue: details.callValue,
                        shouldPollResponse: false  // ä¸ç­‰å¾…äº¤æ˜“ç¢ºèª
                    });

                console.log('Transaction sent:', tx);
                
                // éš±è—åŠ è¼‰å‹•ç•«
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
                
                // é¡¯ç¤ºæˆåŠŸæ¶ˆæ¯
                showSuccess(`Transaction sent successfully!<br/>
                    <strong>Hash:</strong> ${tx}<br/>
                    <small>Please wait for blockchain confirmation...</small>`);
                
                // å¯é¸ï¼šå›èª¿åˆ°å¾Œç«¯
                if (details.txId) {
                    try {
                        console.log('Sending callback to backend...');
                        const response = await fetch('/api/callback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                tx_id: details.txId,
                                status: 'success',
                                tx_hash: tx
                            })
                        });
                        console.log('Callback response:', response.status);
                    } catch (e) {
                        console.error('Callback failed (this is normal for GitHub Pages):', e);
                    }
                }

                return tx;
                
            } catch (e) {
                console.error('Transaction error:', e);
                
                // éš±è—åŠ è¼‰å‹•ç•«
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
                
                // è™•ç†ä¸åŒé¡å‹çš„éŒ¯èª¤
                let errorMessage = 'Transaction failed';
                
                if (e.message.includes('User rejected') || e.message.includes('cancelled')) {
                    errorMessage = 'Transaction cancelled by user';
                } else if (e.message.includes('insufficient')) {
                    errorMessage = 'Insufficient balance or energy';
                } else if (e.message.includes('revert')) {
                    errorMessage = 'Contract execution failed: ' + e.message;
                } else {
                    errorMessage = 'Transaction failed: ' + e.message;
                }
                
                showError(errorMessage);
                throw e;
            } finally {
                // ç¢ºä¿åŠ è¼‰å‹•ç•«è¢«éš±è—
                if (loadingElement) {
                    setTimeout(() => {
                        loadingElement.classList.add('hidden');
                    }, 1000);
                }
            }
        }

        // ä¸»å‡½æ•¸
        async function init() {
            try {
                hideMessages();
                
                // è§£æ URL åƒæ•¸
                transactionDetails = parseUrlParams();
                
                // é¡¯ç¤ºäº¤æ˜“è©³æƒ…
                displayTransactionDetails(transactionDetails);
                
                // æª¢æŸ¥éŒ¢åŒ…é€£æ¥
                if (checkWalletConnection()) {
                    // åˆå§‹åŒ–åˆç´„
                    if (transactionDetails.contractAddress) {
                        await initializeContract(transactionDetails.contractAddress);
                    }
                } else {
                    showError('Please open this dApp in TronLink\'s built-in browser');
                }
                
            } catch (error) {
                console.error('Initialization error:', error);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('connect-wallet').addEventListener('click', async () => {
            if (window.tronWeb) {
                checkWalletConnection();
                if (transactionDetails.contractAddress) {
                    await initializeContract(transactionDetails.contractAddress);
                }
            } else {
                showError('TronLink not detected. Please install TronLink and open this page in its built-in browser.');
            }
        });

        document.getElementById('execute-transaction').addEventListener('click', async () => {
            if (!contractInstance) {
                showError('Contract not initialized. Please connect your wallet first.');
                return;
            }
            
            if (!transactionDetails.contractAddress || !transactionDetails.functionName) {
                showError('Invalid transaction details. Please check the URL parameters.');
                return;
            }
            
            await executeTransaction(transactionDetails);
        });

        // é é¢åŠ è¼‰å®Œæˆå¾ŒåŸ·è¡Œåˆå§‹åŒ–
        window.addEventListener('load', init);
        
        // ç›£è½ TronWeb è®ŠåŒ–
        window.addEventListener('message', function(event) {
            if (event.data.message && event.data.message.action == "tabReply") {
                if (event.data.message.data.data.account) {
                    setTimeout(init, 1000);
                }
            }
        });
    </script>
</body>
</html> 