<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Energy Rental dApp</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.1.0/dist/TronWeb.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl p-6">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold text-gray-800 mb-2">TRON Energy Rental</h1>
                <p class="text-gray-600" id="wallet-status">Checking wallet connection...</p>
            </div>

            <div id="loading" class="text-center py-4 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="mt-2 text-gray-600">Processing transaction...</p>
            </div>

            <div id="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 hidden">
                <span class="block sm:inline" id="error-message"></span>
            </div>

            <div id="success" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative mb-4 hidden">
                <span class="block sm:inline" id="success-message"></span>
            </div>

            <div id="transaction-details" class="bg-gray-50 p-4 rounded-lg mb-4">
                <h2 class="text-lg font-semibold mb-2">Transaction Details</h2>
                <div class="space-y-2">
                    <p><strong>Contract:</strong> <span id="contract-address" class="break-all"></span></p>
                    <p><strong>Function:</strong> <span id="function-name"></span></p>
                    <p><strong>Parameters:</strong> <span id="parameters" class="break-all"></span></p>
                </div>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="confirm-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Confirm Transaction
                </button>
                <button id="cancel-btn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        // 全局變量
        let tronWeb;
        let urlParams;
        let contractInstance;

        // 解析 URL 參數
        function parseUrlParams() {
            urlParams = new URLSearchParams(window.location.search);
            const contractAddress = urlParams.get('contract');
            const functionName = urlParams.get('function');
            let params;
            try {
                params = JSON.parse(urlParams.get('params') || '[]');
            } catch (e) {
                params = [];
            }
            const callValue = parseInt(urlParams.get('value') || '0');
            const feeLimit = parseInt(urlParams.get('feeLimit') || '50000000');
            const txId = urlParams.get('tx_id');

            return {
                contractAddress,
                functionName,
                params,
                callValue,
                feeLimit,
                txId
            };
        }

        // 更新 UI 顯示
        function updateTransactionDetails(details) {
            document.getElementById('contract-address').textContent = details.contractAddress;
            document.getElementById('function-name').textContent = details.functionName;
            document.getElementById('parameters').textContent = JSON.stringify(details.params, null, 2);
        }

        // 顯示錯誤信息
        function showError(message) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // 顯示成功信息
        function showSuccess(message) {
            const successDiv = document.getElementById('success');
            const successMessage = document.getElementById('success-message');
            successMessage.textContent = message;
            successDiv.classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // 檢查錢包連接
        async function checkWallet() {
            const statusElement = document.getElementById('wallet-status');
            
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                statusElement.textContent = `Connected: ${tronWeb.defaultAddress.base58}`;
                return true;
            } else if (window.tronWeb) {
                statusElement.textContent = "TronLink detected but not connected. Please unlock your wallet.";
                return false;
            } else {
                statusElement.textContent = "Please install TronLink and open this page in TronLink's browser.";
                return false;
            }
        }

        // 初始化合約
        async function initContract(address) {
            try {
                contractInstance = await tronWeb.contract().at(address);
                return true;
            } catch (e) {
                showError(`Failed to initialize contract: ${e.message}`);
                return false;
            }
        }

        // 執行交易
        async function executeTransaction(details) {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                // 構建交易參數
                const functionSelector = details.functionName.split('(')[0];
                const params = details.params.map(p => p.value);
                
                // 調用合約函數
                const tx = await contractInstance[functionSelector](...params)
                    .send({
                        feeLimit: details.feeLimit,
                        callValue: details.callValue,
                        shouldPollResponse: true
                    });

                showSuccess(`Transaction successful! Hash: ${tx}`);
                
                // 可選：回調到後端
                if (details.txId) {
                    try {
                        await fetch('/api/callback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                tx_id: details.txId,
                                status: 'success',
                                tx_hash: tx
                            })
                        });
                    } catch (e) {
                        console.error('Callback failed:', e);
                    }
                }

                return tx;
            } catch (e) {
                showError(`Transaction failed: ${e.message}`);
                throw e;
            }
        }

        // 主函數
        async function init() {
            try {
                // 檢查錢包
                if (!await checkWallet()) {
                    return;
                }

                // 解析參數
                const details = parseUrlParams();
                if (!details.contractAddress || !details.functionName) {
                    showError('Invalid URL parameters');
                    return;
                }

                // 更新 UI
                updateTransactionDetails(details);

                // 初始化合約
                if (!await initContract(details.contractAddress)) {
                    return;
                }

                // 設置按鈕事件
                document.getElementById('confirm-btn').onclick = async () => {
                    try {
                        await executeTransaction(details);
                    } catch (e) {
                        console.error('Transaction execution failed:', e);
                    }
                };

                document.getElementById('cancel-btn').onclick = () => {
                    window.close();
                };

            } catch (e) {
                showError(`Initialization failed: ${e.message}`);
            }
        }

        // 頁面加載完成後初始化
        window.onload = init;
    </script>
</body>
</html> 