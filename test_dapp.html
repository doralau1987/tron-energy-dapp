<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Energy Rental dApp - Test Version</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.1.0/dist/TronWeb.js"></script>
    <style>
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: #f0f0f0;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Debug Panel -->
    <div class="debug-panel">
        <h3 class="font-bold">Debug Info</h3>
        <div id="debug-info"></div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">
                🔋 TRON Energy Rental dApp (Test)
            </h1>
            
            <!-- 測試按鈕 -->
            <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-2">🧪 Test Functions</h3>
                <div class="space-x-2">
                    <button id="test-params" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded text-sm">
                        Test URL Params
                    </button>
                    <button id="test-wallet" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded text-sm">
                        Test Wallet
                    </button>
                    <button id="simulate-tx" class="bg-pink-600 hover:bg-pink-700 text-white px-3 py-1 rounded text-sm">
                        Simulate Transaction
                    </button>
                </div>
            </div>
            
            <!-- 合約詳情 -->
            <div id="contract-details" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-lg font-semibold text-blue-800 mb-2">📋 Contract Details</h2>
                <div class="space-y-1 text-sm">
                    <p><strong>Contract:</strong> <span id="contract-address" class="font-mono"></span></p>
                    <p><strong>Function:</strong> <span id="function-name" class="font-mono"></span></p>
                    <p><strong>Parameters:</strong> <span id="parameters" class="font-mono"></span></p>
                    <p><strong>Value:</strong> <span id="call-value"></span> TRX</p>
                    <p><strong>Fee Limit:</strong> <span id="fee-limit"></span> SUN</p>
                </div>
            </div>
            
            <!-- 錢包狀態 -->
            <div id="wallet-status" class="mb-6 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">💳 Wallet Status</h2>
                <p id="wallet-info" class="text-sm"></p>
            </div>
            
            <!-- 操作按鈕 -->
            <div id="action-buttons" class="mb-6 text-center">
                <button id="connect-wallet" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-2">
                    Connect Wallet
                </button>
                <button id="execute-transaction" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>
                    Execute Transaction
                </button>
            </div>
            
            <!-- 加載動畫 -->
            <div id="loading" class="hidden text-center mb-6">
                <div class="inline-flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-2">Processing...</span>
                </div>
            </div>
            
            <!-- 錯誤信息 -->
            <div id="error" class="hidden mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>
            
            <!-- 成功信息 -->
            <div id="success" class="hidden mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <strong>Success:</strong> <span id="success-message"></span>
            </div>
        </div>
    </div>

    <script>
        let tronWeb;
        let contractInstance;
        let transactionDetails;
        let debugLog = [];

        // Debug 函數
        function debug(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.push(`[${timestamp}] ${message}`);
            document.getElementById('debug-info').innerHTML = debugLog.slice(-10).join('<br/>');
            console.log(message);
        }

        // 顯示錯誤信息
        function showError(message) {
            debug(`ERROR: ${message}`);
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            errorMessage.innerHTML = message;
            errorDiv.classList.remove('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // 顯示成功信息
        function showSuccess(message) {
            debug(`SUCCESS: ${message}`);
            const successDiv = document.getElementById('success');
            const successMessage = document.getElementById('success-message');
            successMessage.innerHTML = message;
            successDiv.classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // 隱藏所有狀態信息
        function hideMessages() {
            document.getElementById('error').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        // 解析 URL 參數（測試版本包含默認值）
        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            const details = {
                txId: urlParams.get('tx_id') || 'test_tx_12345',
                contractAddress: urlParams.get('contract') || 'TQb3Bj46dTqwzQ4ynTLDrHzDLpW2gxyl',
                functionName: urlParams.get('function') || 'rentEnergy',
                params: urlParams.get('params') ? JSON.parse(urlParams.get('params')) : [
                    {"type": "uint256", "value": "1000"},
                    {"type": "uint256", "value": "86400"}
                ],
                callValue: parseInt(urlParams.get('value') || '0'),
                feeLimit: parseInt(urlParams.get('feeLimit') || '50000000')
            };
            
            debug(`Parsed params: ${JSON.stringify(details)}`);
            return details;
        }

        // 顯示交易詳情
        function displayTransactionDetails(details) {
            document.getElementById('contract-address').textContent = details.contractAddress || 'Not specified';
            document.getElementById('function-name').textContent = details.functionName || 'Not specified';
            document.getElementById('parameters').textContent = JSON.stringify(details.params, null, 2);
            document.getElementById('call-value').textContent = (details.callValue / 1000000).toFixed(6);
            document.getElementById('fee-limit').textContent = details.feeLimit.toLocaleString();
        }

        // 檢查錢包連接
        function checkWalletConnection() {
            debug('Checking wallet connection...');
            
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;
                
                debug(`Wallet connected: ${address}`);
                
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-green-600">✅ Connected</span><br/>
                    <strong>Address:</strong> ${address}<br/>
                    <strong>Network:</strong> ${tronWeb.fullNode.host}
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
                document.getElementById('connect-wallet').style.display = 'none';
                document.getElementById('execute-transaction').disabled = false;
                
                return true;
            } else {
                debug('Wallet not connected');
                
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-red-600">❌ Not Connected</span><br/>
                    Please open this dApp in TronLink's built-in browser
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                document.getElementById('connect-wallet').style.display = 'inline-block';
                document.getElementById('execute-transaction').disabled = true;
                
                return false;
            }
        }

        // 初始化合約
        async function initializeContract(contractAddress) {
            try {
                debug(`Initializing contract: ${contractAddress}`);
                
                if (!tronWeb) {
                    throw new Error('TronWeb not available');
                }
                
                contractInstance = await tronWeb.contract().at(contractAddress);
                debug('Contract initialized successfully');
                return true;
            } catch (error) {
                debug(`Contract init failed: ${error.message}`);
                showError(`Failed to initialize contract: ${error.message}`);
                return false;
            }
        }

        // 執行交易（改進版本）
        async function executeTransaction(details) {
            let loadingElement = null;
            
            try {
                debug('Starting transaction execution');
                
                loadingElement = document.getElementById('loading');
                if (loadingElement) {
                    loadingElement.classList.remove('hidden');
                    loadingElement.innerHTML = '<div class="inline-flex items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-2">Waiting for wallet approval...</span></div>';
                }
                
                // 構建交易參數
                const functionSelector = details.functionName.split('(')[0];
                const params = details.params.map(p => p.value);
                
                debug(`Calling ${functionSelector} with params: [${params.join(', ')}]`);
                
                // 更新狀態
                if (loadingElement) {
                    loadingElement.innerHTML = '<div class="inline-flex items-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div><span class="ml-2">Signing transaction...</span></div>';
                }
                
                // 檢查合約實例
                if (!contractInstance) {
                    throw new Error('Contract not initialized');
                }
                
                // 檢查函數是否存在
                if (!contractInstance[functionSelector]) {
                    throw new Error(`Function ${functionSelector} not found in contract`);
                }
                
                debug('Sending transaction...');
                
                // 調用合約函數
                const tx = await contractInstance[functionSelector](...params)
                    .send({
                        feeLimit: details.feeLimit,
                        callValue: details.callValue,
                        shouldPollResponse: false  // 不等待交易確認
                    });

                debug(`Transaction sent: ${tx}`);
                
                // 隱藏加載動畫
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
                
                // 顯示成功消息
                showSuccess(`✅ Transaction sent successfully!<br/>
                    <strong>Hash:</strong> <code>${tx}</code><br/>
                    <small>Please wait for blockchain confirmation...</small>`);
                
                return tx;
                
            } catch (e) {
                debug(`Transaction error: ${e.message}`);
                
                // 隱藏加載動畫
                if (loadingElement) {
                    loadingElement.classList.add('hidden');
                }
                
                // 處理不同類型的錯誤
                let errorMessage = 'Transaction failed';
                
                if (e.message.includes('User rejected') || e.message.includes('cancelled')) {
                    errorMessage = '❌ Transaction cancelled by user';
                } else if (e.message.includes('insufficient')) {
                    errorMessage = '❌ Insufficient balance or energy';
                } else if (e.message.includes('revert')) {
                    errorMessage = '❌ Contract execution failed: ' + e.message;
                } else if (e.message.includes('not found')) {
                    errorMessage = '❌ Contract function not found: ' + e.message;
                } else {
                    errorMessage = '❌ Transaction failed: ' + e.message;
                }
                
                showError(errorMessage);
                throw e;
            }
        }

        // 模擬交易（用於測試）
        async function simulateTransaction() {
            debug('Simulating transaction...');
            
            try {
                const mockTx = 'mock_tx_hash_' + Date.now();
                
                document.getElementById('loading').classList.remove('hidden');
                
                // 模擬延遲
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                document.getElementById('loading').classList.add('hidden');
                
                showSuccess(`🎯 Simulated transaction successful!<br/>
                    <strong>Mock Hash:</strong> <code>${mockTx}</code><br/>
                    <small>This is a test simulation</small>`);
                
            } catch (e) {
                showError('Simulation failed: ' + e.message);
            }
        }

        // 主函數
        async function init() {
            try {
                debug('Initializing dApp...');
                hideMessages();
                
                // 解析 URL 參數
                transactionDetails = parseUrlParams();
                
                // 顯示交易詳情
                displayTransactionDetails(transactionDetails);
                
                // 檢查錢包連接
                if (checkWalletConnection()) {
                    // 初始化合約
                    if (transactionDetails.contractAddress) {
                        await initializeContract(transactionDetails.contractAddress);
                    }
                } else {
                    debug('Wallet not connected, showing error');
                    showError('Please open this dApp in TronLink\'s built-in browser');
                }
                
            } catch (error) {
                debug(`Initialization error: ${error.message}`);
                showError(`Initialization failed: ${error.message}`);
            }
        }

        // 事件監聽器
        document.getElementById('connect-wallet').addEventListener('click', async () => {
            debug('Connect wallet button clicked');
            if (window.tronWeb) {
                checkWalletConnection();
                if (transactionDetails.contractAddress) {
                    await initializeContract(transactionDetails.contractAddress);
                }
            } else {
                showError('TronLink not detected. Please install TronLink and open this page in its built-in browser.');
            }
        });

        document.getElementById('execute-transaction').addEventListener('click', async () => {
            debug('Execute transaction button clicked');
            
            if (!contractInstance) {
                showError('Contract not initialized. Please connect your wallet first.');
                return;
            }
            
            if (!transactionDetails.contractAddress || !transactionDetails.functionName) {
                showError('Invalid transaction details. Please check the URL parameters.');
                return;
            }
            
            await executeTransaction(transactionDetails);
        });

        // 測試按鈕事件
        document.getElementById('test-params').addEventListener('click', () => {
            debug('Testing URL parameters...');
            displayTransactionDetails(transactionDetails);
            showSuccess('URL parameters parsed and displayed successfully!');
        });

        document.getElementById('test-wallet').addEventListener('click', () => {
            debug('Testing wallet connection...');
            checkWalletConnection();
        });

        document.getElementById('simulate-tx').addEventListener('click', simulateTransaction);

        // 頁面加載完成後執行初始化
        window.addEventListener('load', init);
        
        // 初始化調試信息
        debug('dApp test version loaded');
    </script>
</body>
</html> 