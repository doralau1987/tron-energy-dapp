<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRON Energy Rental dApp - Working Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tronweb@5.1.0/dist/TronWeb.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-center text-blue-600 mb-8">
                üîã TRON Energy Rental dApp
            </h1>
            
            <!-- Á∂≤Áµ°ÁãÄÊÖã -->
            <div id="network-status" class="mb-6 p-4 bg-gray-50 rounded-lg">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">üåê Network Status</h2>
                <p id="network-info" class="text-sm text-gray-600">Checking network...</p>
            </div>
            
            <!-- ÂêàÁ¥ÑË©≥ÊÉÖ -->
            <div id="contract-details" class="mb-6 p-4 bg-blue-50 rounded-lg">
                <h2 class="text-lg font-semibold text-blue-800 mb-2">üìã Contract Details</h2>
                <div class="space-y-1 text-sm">
                    <p><strong>Target Contract:</strong> <span id="target-contract" class="font-mono"></span></p>
                    <p><strong>Working Contract:</strong> <span id="working-contract" class="font-mono"></span></p>
                    <p><strong>Function:</strong> <span id="function-name" class="font-mono"></span></p>
                    <p><strong>Parameters:</strong> <span id="parameters" class="font-mono"></span></p>
                </div>
            </div>
            
            <!-- Èå¢ÂåÖÁãÄÊÖã -->
            <div id="wallet-status" class="mb-6 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2">üí≥ Wallet Status</h2>
                <p id="wallet-info" class="text-sm"></p>
            </div>
            
            <!-- Êìç‰ΩúÊåâÈàï -->
            <div id="action-buttons" class="mb-6 text-center space-x-2">
                <button id="connect-wallet" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Connect Wallet
                </button>
                <button id="test-transfer" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" disabled>
                    Test Transfer
                </button>
                <button id="execute-original" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded" disabled>
                    Try Original Contract
                </button>
            </div>
            
            <!-- ÁãÄÊÖã‰ø°ÊÅØ -->
            <div id="loading" class="hidden text-center mb-6">
                <div class="inline-flex items-center">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span class="ml-2">Processing...</span>
                </div>
            </div>
            
            <div id="error" class="hidden mb-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
                <strong>Error:</strong> <span id="error-message"></span>
            </div>
            
            <div id="success" class="hidden mb-6 p-4 bg-green-100 border border-green-400 text-green-700 rounded">
                <strong>Success:</strong> <span id="success-message"></span>
            </div>
            
            <!-- Ë™™Êòé -->
            <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                <h3 class="font-semibold text-yellow-800 mb-2">üìñ Working Solution</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>‚Ä¢ This version automatically detects your network</li>
                    <li>‚Ä¢ Uses working contracts for testing</li>
                    <li>‚Ä¢ Falls back to USDT contract if your contract is not deployed</li>
                    <li>‚Ä¢ Shows detailed error messages and suggestions</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        let tronWeb;
        let contractInstance;
        let workingContract;
        let transactionDetails;

        // Â∑≤Áü•ÁöÑÂ∑•‰ΩúÂêàÁ¥ÑÂú∞ÂùÄ
        const CONTRACTS = {
            mainnet: {
                usdt: 'TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t',
                target: 'TQb3Bj46dTqwzQ4ynTLDrHzDLpW2gxyl'
            },
            nile: {
                usdt: 'TXYZopYRdj2D9XRtbG411XZZ3kM5VkAeBf',
                target: 'TQb3Bj46dTqwzQ4ynTLDrHzDLpW2gxyl'
            },
            shasta: {
                usdt: 'TG3XXyExBkPp9nzdajDZsozEu4BkaSJozs',
                target: 'TQb3Bj46dTqwzQ4ynTLDrHzDLpW2gxyl'
            }
        };

        function showError(message) {
            document.getElementById('error-message').innerHTML = message;
            document.getElementById('error').classList.remove('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        function showSuccess(message) {
            document.getElementById('success-message').innerHTML = message;
            document.getElementById('success').classList.remove('hidden');
            document.getElementById('error').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        function hideMessages() {
            document.getElementById('error').classList.add('hidden');
            document.getElementById('success').classList.add('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        function detectNetwork(host) {
            if (host.includes('api.trongrid.io')) {
                return 'mainnet';
            } else if (host.includes('nile')) {
                return 'nile';
            } else if (host.includes('shasta')) {
                return 'shasta';
            }
            return 'unknown';
        }

        function parseUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                txId: urlParams.get('tx_id'),
                contractAddress: urlParams.get('contract'),
                functionName: urlParams.get('function'),
                params: urlParams.get('params') ? JSON.parse(urlParams.get('params')) : [],
                callValue: parseInt(urlParams.get('value') || '0'),
                feeLimit: parseInt(urlParams.get('feeLimit') || '50000000')
            };
        }

        function updateUI() {
            if (transactionDetails) {
                document.getElementById('target-contract').textContent = transactionDetails.contractAddress || 'Not specified';
                document.getElementById('function-name').textContent = transactionDetails.functionName || 'Not specified';
                document.getElementById('parameters').textContent = JSON.stringify(transactionDetails.params, null, 2);
            }
            
            if (workingContract) {
                document.getElementById('working-contract').textContent = workingContract;
            }
        }

        function updateNetworkStatus(networkType, host) {
            const networkInfo = document.getElementById('network-info');
            networkInfo.innerHTML = `
                <strong>Network:</strong> ${networkType}<br/>
                <strong>Host:</strong> ${host}<br/>
                <strong>Status:</strong> <span class="text-green-600">Connected</span>
            `;
            document.getElementById('network-status').className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
        }

        async function checkWalletConnection() {
            if (window.tronWeb && window.tronWeb.ready) {
                tronWeb = window.tronWeb;
                const address = tronWeb.defaultAddress.base58;
                const host = tronWeb.fullNode.host;
                const networkType = detectNetwork(host);
                
                updateNetworkStatus(networkType, host);
                
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-green-600">‚úÖ Connected</span><br/>
                    <strong>Address:</strong> ${address}
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded-lg';
                document.getElementById('connect-wallet').style.display = 'none';
                document.getElementById('test-transfer').disabled = false;
                document.getElementById('execute-original').disabled = false;
                
                return { connected: true, networkType, host, address };
            } else {
                document.getElementById('wallet-info').innerHTML = `
                    <span class="text-red-600">‚ùå Not Connected</span><br/>
                    Please open this dApp in TronLink's built-in browser
                `;
                document.getElementById('wallet-status').className = 'mb-6 p-4 bg-red-50 border border-red-200 rounded-lg';
                return { connected: false };
            }
        }

        async function initializeContract(contractAddress, networkType) {
            try {
                console.log(`Initializing contract: ${contractAddress} on ${networkType}`);
                
                // Ê™¢Êü•ÂêàÁ¥ÑÊòØÂê¶Â≠òÂú®
                try {
                    const contractInfo = await tronWeb.trx.getContract(contractAddress);
                    if (contractInfo && contractInfo.contract_address) {
                        console.log('Contract exists, creating instance...');
                        const instance = await tronWeb.contract().at(contractAddress);
                        return { success: true, instance, address: contractAddress };
                    }
                } catch (e) {
                    console.log('Contract not found:', e.message);
                }
                
                // Â¶ÇÊûúÂéüÂêàÁ¥Ñ‰∏çÂ≠òÂú®Ôºå‰ΩøÁî®ÂÇôÁî®ÁöÑ USDT ÂêàÁ¥Ñ
                const usdtContract = CONTRACTS[networkType]?.usdt;
                if (usdtContract) {
                    console.log(`Falling back to USDT contract: ${usdtContract}`);
                    const instance = await tronWeb.contract().at(usdtContract);
                    return { success: true, instance, address: usdtContract, fallback: true };
                }
                
                throw new Error('No working contract found for this network');
                
            } catch (error) {
                console.error('Contract initialization failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function executeTransfer(amount = 1000000) {
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                if (!contractInstance) {
                    throw new Error('Contract not initialized');
                }
                
                // ÂòóË©¶Âü∑Ë°å‰∏ÄÂÄãÁ∞°ÂñÆÁöÑËΩâÂ∏≥ÊàñÊü•Ë©¢
                const methods = Object.keys(contractInstance).filter(key => typeof contractInstance[key] === 'function');
                console.log('Available methods:', methods);
                
                // ÂòóË©¶Êü•Ë©¢ÊñπÊ≥ï
                if (methods.includes('name')) {
                    const name = await contractInstance.name().call();
                    showSuccess(`‚úÖ Contract interaction successful!<br/>
                        <strong>Contract Name:</strong> ${name}<br/>
                        <strong>Available Methods:</strong> ${methods.slice(0, 5).join(', ')}`);
                } else if (methods.includes('balanceOf')) {
                    const balance = await contractInstance.balanceOf(tronWeb.defaultAddress.base58).call();
                    showSuccess(`‚úÖ Contract query successful!<br/>
                        <strong>Your Balance:</strong> ${balance}<br/>
                        <strong>Available Methods:</strong> ${methods.slice(0, 5).join(', ')}`);
                } else {
                    showSuccess(`‚úÖ Contract initialized successfully!<br/>
                        <strong>Available Methods:</strong> ${methods.slice(0, 10).join(', ')}<br/>
                        <small>Contract is ready for transactions</small>`);
                }
                
            } catch (error) {
                showError(`‚ùå Transaction failed: ${error.message}`);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function tryOriginalContract() {
            if (!transactionDetails.contractAddress) {
                showError('‚ùå No original contract address provided');
                return;
            }
            
            try {
                document.getElementById('loading').classList.remove('hidden');
                
                const result = await initializeContract(transactionDetails.contractAddress, 'current');
                
                if (result.success) {
                    contractInstance = result.instance;
                    workingContract = result.address;
                    updateUI();
                    
                    showSuccess(`‚úÖ Original contract initialized!<br/>
                        <strong>Address:</strong> ${result.address}<br/>
                        <small>You can now execute transactions</small>`);
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                showError(`‚ùå Original contract failed: ${error.message}<br/>
                    <small>The contract may not be deployed on this network</small>`);
            } finally {
                document.getElementById('loading').classList.add('hidden');
            }
        }

        async function init() {
            hideMessages();
            
            transactionDetails = parseUrlParams();
            updateUI();
            
            const walletStatus = await checkWalletConnection();
            
            if (walletStatus.connected) {
                const result = await initializeContract(
                    transactionDetails.contractAddress || CONTRACTS[walletStatus.networkType]?.target,
                    walletStatus.networkType
                );
                
                if (result.success) {
                    contractInstance = result.instance;
                    workingContract = result.address;
                    updateUI();
                    
                    if (result.fallback) {
                        showSuccess(`‚ö†Ô∏è Using fallback contract for testing<br/>
                            <strong>Contract:</strong> ${result.address}<br/>
                            <small>Your original contract may not be deployed yet</small>`);
                    } else {
                        showSuccess(`‚úÖ Contract ready: ${result.address.substring(0, 10)}...`);
                    }
                } else {
                    showError(`‚ùå Failed to initialize any contract: ${result.error}`);
                }
            }
        }

        // ‰∫ã‰ª∂Áõ£ËÅΩÂô®
        document.getElementById('connect-wallet').addEventListener('click', init);
        document.getElementById('test-transfer').addEventListener('click', executeTransfer);
        document.getElementById('execute-original').addEventListener('click', tryOriginalContract);

        window.addEventListener('load', init);
    </script>
</body>
</html> 